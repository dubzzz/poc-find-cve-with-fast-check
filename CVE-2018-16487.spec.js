// https://security.snyk.io/vuln/SNYK-JS-LODASH-73638
const _ = require('lodash-4.17.10');

const { test } = require('@jest/globals');
const fc = require('fast-check');
const { assertNoPoisoning, restoreGlobals } = require('@fast-check/poisoning');

fc.configureGlobal({ afterEach: restoreGlobals });

test('CVE-2018-16487 (merge)', () => {
  fc.assert(
    fc.property(fc.object(), fc.object(), (raw, other) => {
      // Arrange
      const instance = _.cloneDeep(raw); // just not to alter the original object

      // Act
      _.merge(instance, other);

      // Assert
      assertNoPoisoning();
    }),
    { seed: 1571105485, path: '7:0:1:67:67:67', endOnFailure: true }
  );
});
// { seed: 1571105485, path: "7:0:1:67:67:67", endOnFailure: true }

test('CVE-2018-16487 (mergeWith)', () => {
  fc.assert(
    fc.property(fc.object(), fc.object(), fc.func(fc.anything()), (raw, other, customizer) => {
      // Arrange
      const instance = _.cloneDeep(raw); // just not to alter the original object

      // Act
      _.mergeWith(instance, other, customizer);

      // Assert
      assertNoPoisoning();
    }),
    { seed: -627003934, path: '55:68:66:67:69:69:70:69:69:70:70:69:69:70:70:72:68:68:69', endOnFailure: true }
  );
});
// { seed: -627003934, path: "55:68:66:67:69:69:70:69:69:70:70:69:69:70:70:72:68:68:69", endOnFailure: true }

test('CVE-2018-16487 (defaultsDeep)', () => {
  fc.assert(
    fc.property(fc.object(), fc.object(), (raw, other) => {
      // Arrange
      const instance = _.cloneDeep(raw); // just not to alter the original object

      // Act
      _.defaultsDeep(instance, other);

      // Assert
      assertNoPoisoning();
    }),
    { seed: 1208541877, path: '21:1:0:67:66:66:67:67:67', endOnFailure: true }
  );
});
// { seed: 1208541877, path: "21:1:0:67:66:66:67:67:67", endOnFailure: true }
